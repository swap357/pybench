name: Benchmark

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      build_from_source:
        description: 'Build Python from source'
        required: false
        default: 'false'

jobs:
  benchmark:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Cache Python versions
      uses: actions/cache@v4
      with:
        path: ~/.pyenv/versions
        key: ${{ runner.os }}-pyenv-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pyenv-

    - name: Install pyenv dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev \
          libncursesw5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev

    - name: Install and configure pyenv
      run: |
        curl https://pyenv.run | bash
        echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
        echo '[[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc
        echo 'eval "$(pyenv init -)"' >> ~/.bashrc
        source ~/.bashrc

        export PATH="$HOME/.pyenv/bin:$PATH"
        eval "$(pyenv init --path)"
        eval "$(pyenv init -)"
        pyenv --version

    - name: Install Python versions
      run: |
        export PATH="$HOME/.pyenv/bin:$PATH"
        eval "$(pyenv init --path)"
        eval "$(pyenv init -)"

        # Get Python versions from the runner
        VERSIONS=$(python -c "from benchmark_runner import BenchmarkRunner; print(' '.join(BenchmarkRunner.PYTHON_VERSIONS.keys()))")
        
        if [ "${{ github.event.inputs.build_from_source }}" == "true" ]; then
          for version in $VERSIONS; do
            pyenv install $version --force
          done
        else
          for version in $VERSIONS; do
            pyenv install $version || pyenv install $version --patch < <(curl -sSL https://raw.githubusercontent.com/python/cpython/${version}/Misc/NEWS.d/${version}.rst)
          done
        fi

        # Set global Python to baseline version
        BASELINE=$(python -c "from benchmark_runner import BenchmarkRunner; print(BenchmarkRunner.BASELINE_VERSION)")
        pyenv global $BASELINE
        python --version

    - name: Install dependencies
      run: |
        export PATH="$HOME/.pyenv/bin:$PATH"
        eval "$(pyenv init --path)"
        eval "$(pyenv init -)"
        python -m pip install --upgrade pip
        pip install -e .

    - name: Run benchmarks
      run: |
        export PATH="$HOME/.pyenv/bin:$PATH"
        eval "$(pyenv init --path)"
        eval "$(pyenv init -)"
        python benchmark_runner.py --profile basic --report-format both
        ls -l  # Debug: list files to verify JSON was created

    - name: Install script dependencies
      run: |
        python -m pip install plotly kaleido

    - name: Generate Benchmark Report
      run: |
        ls -l  # Debug: verify files before running script
        python scripts/json_to_html.py

    - name: Update Index Page
      run: |
        python scripts/update_index.py

    - name: Publish Benchmark Results to GitHub Pages
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git checkout gh-pages || git checkout -b gh-pages
        
        # Create runs directory if it doesn't exist
        mkdir -p runs
        
        # Copy new files
        cp -r runs/* runs/ || true
        cp index.html .
        
        # Add and commit all changes
        git add index.html runs/
        git commit -m "Update benchmark results (Run ID: $(date +%Y%m%d_%H%M%S))"
        git push origin gh-pages
